using ParsMedeQ.Domain.Aggregates.{{ClassName}}Aggregate;

namespace ParsMedeQ.Application.Features.{{ClassName}}Features.Create{{ClassName}}Feature;

public sealed class Create{{ClassName}}CommandHandler : IPrimitiveResultCommandHandler<Create{{ClassName}}Command, Create{{ClassName}}CommandResponse>
{
    private readonly IWriteUnitOfWork _writeUnitOfWork;
    private readonly IFile{{ClassName}} _file{{ClassName}};

    public Create{{ClassName}}CommandHandler(
        IWriteUnitOfWork writeUnitOfWork,
        IFile{{ClassName}} file{{ClassName}})
    {
        this._writeUnitOfWork = writeUnitOfWork;
        this._file{{ClassName}} = file{{ClassName}};
    }

    public async Task<PrimitiveResult<Create{{ClassName}}CommandResponse>> Handle(Create{{ClassName}}Command request, CancellationToken cancellationToken)
    {
        return await {{ClassName}}.Create(request.TypeId)
            .Map(item => UploadFile(this._file{{ClassName}}, request.ImageInfo?.Bytes, request.ImageInfo?.Extension, "Images", cancellationToken)
                .Map(imagePath => (item, imagePath)))
            .Map(data => data.item.AddTranslation(
                Constants.LangCode_Farsi.ToLower(),
                {{ for prop in Props }}request.{{ prop.Name }}, {{ end }}
                data.imagePath)
                .Map(() => data.item))
            .Map({{CamelClassName}} => this._writeUnitOfWork.{{ClassName}}WriteRepository.Add{{ClassName}}({{CamelClassName}})
            .Map({{CamelClassName}} => this._writeUnitOfWork.SaveChangesAsync(CancellationToken.None).Map(_ => {{CamelClassName}}))
            .Map({{CamelClassName}} => new Create{{ClassName}}CommandResponse({{CamelClassName}} is not null)))
            .ConfigureAwait(false);
    }

    static async ValueTask<PrimitiveResult<string>> UploadFile(
        IFile{{ClassName}} file{{ClassName}},
        byte[] bytes,
        string fileExtension,
        string fodlerName,
        CancellationToken cancellationToken)
    {
        if ((bytes?.Length ?? 0) == 0) return string.Empty;
        var result = await file{{ClassName}}.UploadFile(bytes, fileExtension, fodlerName, cancellationToken)
            .ConfigureAwait(false);
        if (string.IsNullOrWhiteSpace(result)) return PrimitiveResult.Failure<string>("", "Can not upload file");

        return result;
    }
}
